<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jarvis</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');

    :root {
      --bg:       #0d0d0d;
      --surface:  #161616;
      --border:   #242424;
      --cyan:     #00c8ff;
      --cyan-dim: rgba(0,200,255,0.12);
      --green:    #00e587;
      --red:      #ff4757;
      --gold:     #ffb830;
      --text:     #f0f0f0;
      --muted:    #666;
      --radius:   16px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 28px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .logo {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 6px;
      color: var(--cyan);
      text-transform: uppercase;
    }

    .status-dots {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .status-dot {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      color: var(--muted);
    }

    .dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: #333;
      transition: all 0.3s;
    }
    .dot.ok   { background: var(--green); box-shadow: 0 0 5px var(--green); }
    .dot.warn { background: var(--gold);  box-shadow: 0 0 5px var(--gold); }

    /* â”€â”€ Layout â”€â”€ */
    .body {
      flex: 1;
      display: flex;
      overflow: hidden;
      min-height: 0;
    }

    /* â”€â”€ Orb sidebar â”€â”€ */
    .sidebar {
      width: 260px;
      flex-shrink: 0;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 28px;
      padding: 32px 20px;
    }

    .orb-wrap {
      position: relative;
      width: 140px;
      height: 140px;
    }

    /* Outer glow ring */
    .orb-ring {
      position: absolute;
      inset: -8px;
      border-radius: 50%;
      border: 1px solid rgba(0,200,255,0.15);
      transition: all 0.4s;
    }

    .orb-ring.listening { border-color: rgba(255,71,87,0.3); }
    .orb-ring.thinking  { border-color: rgba(255,184,48,0.3); }
    .orb-ring.speaking  { border-color: rgba(0,229,135,0.3); }

    /* Core */
    .orb {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: radial-gradient(circle at 38% 35%, #1a2a30, #0a0a0a);
      border: 1.5px solid rgba(0,200,255,0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.4s;
      box-shadow: 0 0 30px rgba(0,200,255,0.08), inset 0 0 20px rgba(0,200,255,0.05);
    }

    .orb.listening {
      border-color: rgba(255,71,87,0.5);
      box-shadow: 0 0 30px rgba(255,71,87,0.15);
    }
    .orb.thinking {
      border-color: rgba(255,184,48,0.5);
      box-shadow: 0 0 30px rgba(255,184,48,0.15);
      animation: pulse 1s ease-in-out infinite;
    }
    .orb.speaking {
      border-color: rgba(0,229,135,0.5);
      box-shadow: 0 0 40px rgba(0,229,135,0.2);
      animation: pulse-speak 0.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%,100% { transform: scale(1); }
      50%      { transform: scale(1.04); }
    }
    @keyframes pulse-speak {
      0%,100% { transform: scale(1); box-shadow: 0 0 30px rgba(0,229,135,0.2); }
      50%      { transform: scale(1.06); box-shadow: 0 0 50px rgba(0,229,135,0.35); }
    }

    .orb-symbol {
      font-size: 40px;
      line-height: 1;
      opacity: 0.7;
      transition: all 0.3s;
      user-select: none;
    }

    /* State label */
    .state-label {
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--muted);
      transition: color 0.3s;
      height: 16px;
    }
    .state-label.listening { color: var(--red); }
    .state-label.thinking  { color: var(--gold); }
    .state-label.speaking  { color: var(--green); }

    /* Mic button */
    .mic-btn {
      width: 56px; height: 56px;
      border-radius: 50%;
      border: 1.5px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-size: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .mic-btn:hover {
      border-color: var(--cyan);
      background: var(--cyan-dim);
      transform: scale(1.05);
    }

    .mic-btn.active {
      border-color: var(--red);
      background: rgba(255,71,87,0.1);
      animation: mic-pulse 1s ease-in-out infinite;
    }

    @keyframes mic-pulse {
      0%,100% { transform: scale(1); }
      50%      { transform: scale(1.08); }
    }

    .mic-label {
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 1px;
    }

    /* â”€â”€ Chat panel â”€â”€ */
    .chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 32px 32px 16px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      scroll-behavior: smooth;
    }

    #chat::-webkit-scrollbar { width: 4px; }
    #chat::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

    /* Messages */
    .msg { display: flex; flex-direction: column; max-width: 680px; gap: 6px; }
    .msg.user   { align-self: flex-end; align-items: flex-end; }
    .msg.jarvis { align-self: flex-start; align-items: flex-start; }

    .msg-meta {
      font-size: 11px;
      color: var(--muted);
      padding: 0 4px;
    }

    .ai-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      font-weight: 500;
      padding: 3px 9px;
      border-radius: 20px;
      border: 1px solid;
    }

    .bubble {
      padding: 14px 18px;
      border-radius: var(--radius);
      font-size: 15px;
      line-height: 1.65;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .msg.user .bubble {
      background: #1e1e1e;
      border: 1px solid var(--border);
      border-bottom-right-radius: 4px;
      color: var(--text);
    }

    .msg.jarvis .bubble {
      background: #111;
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
      color: var(--text);
    }

    /* Code */
    .bubble code {
      font-family: 'SF Mono', 'Fira Code', monospace;
      background: #1a1a1a;
      padding: 2px 6px;
      border-radius: 5px;
      font-size: 13px;
      color: var(--cyan);
    }
    .bubble pre {
      background: #111;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      overflow-x: auto;
      margin: 8px 0;
    }
    .bubble pre code { background: none; padding: 0; }

    /* Loading */
    .typing {
      display: flex;
      gap: 5px;
      padding: 14px 18px;
      background: #111;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      border-bottom-left-radius: 4px;
      width: fit-content;
    }
    .typing span {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--muted);
      animation: blink 1.3s infinite;
    }
    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink {
      0%,80%,100% { opacity: 0.2; transform: scale(0.8); }
      40%          { opacity: 1;   transform: scale(1); }
    }

    /* â”€â”€ Welcome â”€â”€ */
    .welcome {
      margin: auto;
      text-align: center;
      max-width: 420px;
      padding: 20px;
    }

    .welcome h2 {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--text);
    }

    .welcome p {
      font-size: 14px;
      color: var(--muted);
      line-height: 1.6;
      margin-bottom: 28px;
    }

    .examples {
      display: flex;
      flex-direction: column;
      gap: 8px;
      text-align: left;
    }

    .example {
      padding: 12px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 14px;
      color: #aaa;
      cursor: pointer;
      transition: all 0.15s;
    }
    .example:hover { border-color: #444; color: var(--text); }

    /* â”€â”€ Input â”€â”€ */
    .input-area {
      padding: 20px 32px 24px;
      flex-shrink: 0;
    }

    .input-row {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px 10px 16px;
      transition: border-color 0.2s;
    }

    .input-row:focus-within { border-color: #3a3a3a; }

    #question {
      flex: 1;
      background: none;
      border: none;
      outline: none;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: 15px;
      resize: none;
      min-height: 24px;
      max-height: 120px;
      line-height: 1.5;
    }

    #question::placeholder { color: var(--muted); }

    #send-btn {
      width: 36px; height: 36px;
      border-radius: 9px;
      background: var(--cyan);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s;
      color: #000;
      font-size: 15px;
    }
    #send-btn:hover   { opacity: 0.85; }
    #send-btn:disabled { opacity: 0.25; cursor: not-allowed; }

    .input-hint {
      text-align: center;
      margin-top: 8px;
      font-size: 11px;
      color: #3a3a3a;
    }
  </style>
</head>
<body>

<header>
  <div class="logo">Jarvis</div>
  <div class="status-dots">
    <div class="status-dot"><div class="dot" id="d-claude"></div> Claude</div>
    <div class="status-dot"><div class="dot" id="d-gpt"></div> GPT</div>
    <div class="status-dot"><div class="dot" id="d-gemini"></div> Gemini</div>
    <div class="status-dot"><div class="dot" id="d-pplx"></div> Perplexity</div>
    <div class="status-dot"><div class="dot" id="d-voice"></div> Voice</div>
  </div>
</header>

<div class="body">

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="orb-wrap">
      <div class="orb-ring" id="orb-ring"></div>
      <div class="orb" id="orb">
        <div class="orb-symbol" id="orb-symbol">â—</div>
      </div>
    </div>

    <div class="state-label" id="state-label">Standby</div>

    <button class="mic-btn" id="mic-btn" onclick="toggleMic()">ğŸ™ï¸</button>
    <div class="mic-label">Click to speak</div>
  </div>

  <!-- Chat -->
  <div class="chat-panel">
    <div id="chat">
      <div class="welcome" id="welcome">
        <h2>How can I help?</h2>
        <p>Ask anything â€” I'll route it to the best AI and respond in your voice.</p>
        <div class="examples">
          <div class="example" onclick="useExample(this)">What's in the news today?</div>
          <div class="example" onclick="useExample(this)">Explain quantum computing simply</div>
          <div class="example" onclick="useExample(this)">Write a short poem about the ocean</div>
          <div class="example" onclick="useExample(this)">What's the current Bitcoin price?</div>
        </div>
      </div>
    </div>

    <div class="input-area">
      <div class="input-row">
        <textarea
          id="question"
          placeholder="Ask anything..."
          rows="1"
          onkeydown="handleKey(event)"
          oninput="autoResize(this)"
        ></textarea>
        <button id="send-btn" onclick="sendMessage()">â–¶</button>
      </div>
      <div class="input-hint">Enter to send Â· Shift+Enter for new line</div>
    </div>
  </div>

</div>

<script>
  let isLoading = false;
  let recognition = null;
  let isListening = false;
  let currentAudio = null;

  // â”€â”€ Clock is gone, but health check stays â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function checkHealth() {
    try {
      const r = await fetch('/api/health');
      const d = await r.json();
      const k = d.api_keys_configured;
      const map = { anthropic:'d-claude', openai:'d-gpt', google:'d-gemini', perplexity:'d-pplx', elevenlabs:'d-voice' };
      for (const [key, id] of Object.entries(map)) {
        const el = document.getElementById(id);
        if (el) el.className = 'dot ' + (k[key] ? 'ok' : 'warn');
      }
    } catch {}
  }
  checkHealth();

  // â”€â”€ Orb states â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const STATES = {
    idle:      { label:'Standby',    symbol:'â—', cls:'' },
    listening: { label:'Listening',  symbol:'â—‰', cls:'listening' },
    thinking:  { label:'Thinkingâ€¦',  symbol:'â—ˆ', cls:'thinking' },
    speaking:  { label:'Speaking',   symbol:'â—', cls:'speaking' },
  };

  function setOrb(state) {
    const s = STATES[state] || STATES.idle;
    document.getElementById('orb').className       = 'orb '      + s.cls;
    document.getElementById('orb-ring').className  = 'orb-ring ' + s.cls;
    document.getElementById('orb-symbol').textContent = s.symbol;
    const lbl = document.getElementById('state-label');
    lbl.textContent = s.label;
    lbl.className   = 'state-label ' + s.cls;
  }

  // â”€â”€ Speech recognition â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleMic() {
    isListening ? stopListening() : startListening();
  }

  function startListening() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) { alert('Speech recognition requires Chrome or Edge.'); return; }
    if (currentAudio) { currentAudio.pause(); currentAudio = null; }

    recognition = new SR();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'en-US';

    recognition.onstart = () => {
      isListening = true;
      document.getElementById('mic-btn').classList.add('active');
      setOrb('listening');
    };

    recognition.onresult = (e) => {
      document.getElementById('question').value = e.results[0][0].transcript;
      stopListening();
      sendMessage();
    };

    recognition.onerror = (e) => { if (e.error !== 'aborted') stopListening(); };
    recognition.onend   = stopListening;
    recognition.start();
  }

  function stopListening() {
    isListening = false;
    document.getElementById('mic-btn').classList.remove('active');
    if (recognition) { try { recognition.stop(); } catch {} recognition = null; }
    if (!isLoading) setOrb('idle');
  }

  // â”€â”€ ElevenLabs TTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function speak(text) {
    setOrb('speaking');
    try {
      const res = await fetch('/api/speak', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text }),
      });
      if (!res.ok) { setOrb('idle'); return; }
      const url = URL.createObjectURL(await res.blob());
      currentAudio = new Audio(url);
      currentAudio.onended = () => { setOrb('idle'); URL.revokeObjectURL(url); };
      currentAudio.onerror = () => setOrb('idle');
      await currentAudio.play();
    } catch { setOrb('idle'); }
  }

  // â”€â”€ Render helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function esc(t) {
    return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function render(text) {
    return text
      .replace(/```(\w*)\n([\s\S]*?)```/g, (_,l,c) => `<pre><code>${esc(c.trim())}</code></pre>`)
      .replace(/`([^`]+)`/g, '<code>$1</code>')
      .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
      .replace(/\*([^*]+)\*/g, '<em>$1</em>')
      .replace(/\n/g, '<br>');
  }

  // â”€â”€ Add message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function addMsg(role, content, meta = null) {
    document.getElementById('welcome')?.remove();
    const chat = document.getElementById('chat');
    const el = document.createElement('div');
    el.className = `msg ${role}`;

    if (role === 'jarvis' && meta) {
      const c = meta.llm_color;
      el.innerHTML = `
        <div class="ai-badge" style="border-color:${c}40;color:${c};background:${c}12">
          <span style="width:5px;height:5px;border-radius:50%;background:${c};display:inline-block"></span>
          ${meta.llm_display}
        </div>
        <div class="bubble">${render(content)}</div>`;
    } else {
      el.innerHTML = `<div class="bubble">${esc(content)}</div>`;
    }

    chat.appendChild(el);
    chat.scrollTop = chat.scrollHeight;
  }

  function showTyping() {
    document.getElementById('welcome')?.remove();
    const chat = document.getElementById('chat');
    const el = document.createElement('div');
    el.className = 'msg jarvis';
    el.id = 'typing';
    el.innerHTML = `<div class="typing"><span></span><span></span><span></span></div>`;
    chat.appendChild(el);
    chat.scrollTop = chat.scrollHeight;
  }

  function hideTyping() { document.getElementById('typing')?.remove(); }

  // â”€â”€ Examples â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function useExample(el) {
    document.getElementById('question').value = el.textContent;
    sendMessage();
  }

  // â”€â”€ Textarea â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function autoResize(ta) {
    ta.style.height = 'auto';
    ta.style.height = Math.min(ta.scrollHeight, 120) + 'px';
  }

  function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  }

  // â”€â”€ Send â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function sendMessage() {
    if (isLoading) return;
    const ta = document.getElementById('question');
    const q  = ta.value.trim();
    if (!q) return;

    ta.value = '';
    ta.style.height = 'auto';
    isLoading = true;
    document.getElementById('send-btn').disabled = true;

    addMsg('user', q);
    showTyping();
    setOrb('thinking');

    try {
      const res = await fetch('/api/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question: q }),
      });
      const data = await res.json();
      hideTyping();

      if (data.error) {
        addMsg('jarvis', `Error: ${data.error}`);
        setOrb('idle');
      } else {
        addMsg('jarvis', data.answer, { llm_display: data.llm_display, llm_color: data.llm_color });
        await speak(data.answer);
      }
    } catch (e) {
      hideTyping();
      addMsg('jarvis', `Connection error â€” is the server running?`);
      setOrb('idle');
    }

    isLoading = false;
    document.getElementById('send-btn').disabled = false;
    ta.focus();
  }
</script>
</body>
</html>
